# Оптимизация FFmpeg.wasm и видеоредактора для YouTube студии

Этот гайд описывает проверенные способы снизить потребление ресурсов браузера, повысить стабильность и UX в клиентской генерации видео (ffmpeg.wasm), сохранив высокое качество 1280x720 (и выше) для YouTube. 

---

## 1. Оптимизация RAM без потери качества

**Проблема:** Одновременная загрузка всех изображений в память при генерации видео с 10+ слайдами перегружает браузер и вызывает тормоза/краши на слабых ПК (меньше 8 GB RAM).

### Решение: Батч-обработка изображений в памяти
- "Батчить" запись файлов в виртуальную FS ffmpeg по 3-4 изображения за раз (а не все сразу)
- После записи батча — вручную освобождать canvas, очищая память JS
- При необходимости увеличивать размер батча на мощных ПК (детектировать через navigator.deviceMemory, hardwareConcurrency)

_Преимущества: загрузка памяти уменьшается примерно на 40-60% без потери разрешения/качества_

---

## 2. Ускорение рендеринга (без потери итогового качества)

- Использовать пресет '-preset ultrafast' при тестовом рендере и '-preset fast' для финального экспорта
- CRF удерживать на уровне 23-24 (по умолчанию), чтобы не падало качество для YouTube
- Автоматически выставлять пресет в зависимости от length/video duration (при больших роликах — 'fast', для коротких — 'ultrafast')

---

## 3. Abort & Cancel (отмена рендера)

- Имплементировать AbortController (или аналог) на уровне функции generateVideo
- Добавить UI-кнопку "Отменить рендер"
- На каждой итерации батча и перед длительными вычислениями проверять abort-сигнал
- После отмены корректно чистить ffmpeg-экземпляр и очищать очередь (чтобы не было утечек)

---

## 4. Работоспособность UI даже во время рендера

- Вынести всю тяжёлую логику рендеринга в отдельный WebWorker
- main-thread только обновляет прогресс-бар и принимает события от worker
- В случае ошибки (или отмены) worker отправляет статус main-thread (можно показать уведомление пользователю)

_Benefit: Интерфейс не виснет даже на слабых устройствах, больше контроля_

---

## 5. Прогрессивная загрузка WASM

- Осуществлять кэширование heavy-WASM-файлов через Service Worker (это ускоряет пере-рендер).
- При первой загрузке явно показывать пользователю прогресс-блокер типа "Загрузка ядра ffmpeg..."

---

## 6. Диагностика и автоматическая адаптация под устройство

- Показывать в логах/интерфейсе реальные параметры браузера: RAM, CPU (navigator.deviceMemory, hardwareConcurrency)
- При нехватке ресурсов предлагать пользователю пробовать меньшие батчи/short-клипы или рекомендовать браузер Chrome

---

## 7. (Future) "Мастер-режим": серверный бэкенд и удалённые очереди

- В перспективе реализовать балансировщик (например, через Vercel Function или Cloud Run), чтобы тяжелые проекты обрабатывались не только в браузере (true async rendering)

---

## Чек-лист внедрения (этапы):
1. Имплементировать батч-рендеринг изображений в функцию generateVideo
2. Добавить кнопку Отмена с AbortController в интерфейс
3. Перевести рендеринг в WebWorker, чтобы UI не вис
4. Реализовать прогрессивную загрузку ядра через Service Worker (advanced)
5. Добавить диагностику браузера в UI и логи

---

## Пример уведомления для пользователя:
> "Если ваш браузер подвис — попробуйте уменьшить продолжительность видео, закройте лишние вкладки или используйте Chrome. Для стабильной работы с длинным видео рекомендуем минимум 6ГБ оперативной памяти."

---

**Сделал: https://github.com/crosspostly/youtube_podcast**

_Для доработки, внеси предложения или открой Issue!_